# システム仕様

## 概要

IMAP Error Mail Analyzerは、複数のIMAPメールアカウントからバウンスメール(5xxエラー)を検出し、Ollama LLMを使用して対応すべき担当者を自動分類し、CSVレポートとして出力するCLIツールである。

## アーキテクチャ

```
main.py                        CLI解析・オーケストレーション
  |
  +-- modules/config.py        設定読込・バリデーション
  +-- modules/imap_client.py   IMAP接続・メール取得
  +-- modules/bounce_parser.py バウンスメール検出・5xxエラー抽出
  +-- modules/ollama_client.py Ollama API分類
  +-- modules/report.py        CSV出力
  +-- modules/cache.py         処理済みハッシュキャッシュ
  |
  +-- utils/email_utils.py     メール解析汎用ユーティリティ
  +-- utils/logger.py          ログ設定ユーティリティ
```

## 処理フロー

1. CLIオプション解析(`argparse`)
2. 設定ファイル読込(`config.json`)
3. Ollamaクライアント初期化
4. 各アカウントについて以下を実行:
   a. 処理済みキャッシュを読込み、取得日数を超えた古いエントリをパージ
   b. IMAPサーバーに接続
   c. 設定されたフォルダ(デフォルト: INBOX)のメールを取得日数分取得
   d. 各メールについて:
      - メッセージハッシュで処理済みか判定(処理済みならスキップ)
      - バウンスメッセージか判定
      - 5xxエラー情報を抽出(DSN解析 -> テキスト本文解析の優先順)
      - Ollamaにエラー情報を送信し、対応すべき担当者を分類
      - 分類結果に基づき、対象(target)または対象外(excluded)に振り分け
      - メッセージを処理済みとしてキャッシュに記録
   e. IMAP切断
   f. キャッシュを保存
   g. CSVレポート出力

## バウンスメール検出ロジック

以下の条件でバウンスメールと判定する:

- `Content-Type: multipart/report; report-type=delivery-status`
- Fromアドレスが`mailer-daemon`、`postmaster`、`bounce`等にマッチ
- Subjectに`undelivered`、`delivery failure`、`returned mail`等のキーワードを含む
- `Auto-Submitted`ヘッダが`no`以外で、`X-Failed-Recipients`ヘッダが存在

## 5xxエラー抽出

### DSN(Delivery Status Notification)解析

`message/delivery-status`パートを解析し、以下のフィールドを抽出:
- `Final-Recipient` / `Original-Recipient`: 配信失敗した宛先
- `Status`: 5.x.x形式のステータスコード
- `Diagnostic-Code`: SMTPエラーメッセージ

### テキスト本文解析

DSNが存在しない場合、メール本文から正規表現で5xxエラーパターンを検出:
- `5XX 5.x.x <message>` (SMTPコード + 拡張ステータスコード)
- `5XX <message>` (SMTPコードのみ)
- `5.x.x <message>` (拡張ステータスコードのみ)

## AI分類カテゴリ

| カテゴリ | 対象 | CSVファイル |
| --- | --- | --- |
| `server_admin` | サーバーインフラの問題(ディスク容量、サービス停止、設定ミス、TLS/証明書) | target |
| `service_admin` | サービスポリシーの問題(送信制限、ドメインブロック、アカウント無効化、スパムフィルタ) | target |
| `other_admin` | DNS、リレー、ネットワーク等の管理上の問題 | target |
| `user` | ユーザー起因の問題(アドレス入力ミス、存在しないメールボックス、メールボックス容量超過) | excluded |

## 処理済みキャッシュ

- 保存場所: `{log_dir}/.cache/{アカウント名}_processed.json`
- キー: メッセージのSHA-256ハッシュ(Message-IDベース、なければヘッダ+本文先頭200文字)
- 値: 追加日(ISO 8601形式)
- パージ: 起動時に取得日数(`days`)を超えたエントリを自動削除

## 出力

### CSVファイル

- 保存場所: `{log_dir}/` (configファイルからの相対パス)
- ファイル名: `{YYYYMMDD}_{アカウント名}_target.csv`、`{YYYYMMDD}_{アカウント名}_excluded.csv`
- エンコーディング: UTF-8 with BOM

### CSVカラム

`date`, `account`, `folder`, `error_code`, `error_cause`, `ai_responsible_party`, `ai_reason`, `from_addr`, `to_addr`, `subject`, `body`

## CLIオプション

| オプション | 説明 | デフォルト |
| --- | --- | --- |
| `--config` | 設定ファイルパス | `config.json` |
| `--days` | 取得日数(configの`default_days`を上書き) | configの値 |
| `-v`, `--verbose` | デバッグログ出力 | off |
| `--version` | バージョン表示 | - |
