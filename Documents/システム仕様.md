# システム仕様

## 概要

IMAP Error Mail Analyzerは、複数のIMAPメールアカウントからバウンスメール(5xxエラー)を検出し、Ollama LLMを使用して対応すべき担当者を自動分類し、JSONレポートとして出力するCLIツールである。

## アーキテクチャ

```
main.py                        CLI引数解析・ディスパッチ
  |
  +-- modules/cli.py           CLIコマンド実装(run_main/run_cleanup/run_report)
  +-- modules/config.py        設定読込・バリデーション
  +-- modules/imap_client.py   IMAP接続・メール取得
  +-- modules/bounce_parser.py 5xxエラー抽出
  +-- modules/ollama_client.py Ollama API分類
  +-- modules/report.py        JSON出力
  +-- modules/html_report.py   HTMLレポート生成
  +-- modules/cache.py         処理済みハッシュキャッシュ
  |
  +-- utils/categories.py      カテゴリ定義一元管理
  +-- utils/date_utils.py      日付解析ユーティリティ
  +-- utils/email_utils.py     メール解析汎用ユーティリティ
  +-- utils/logger.py          ログ設定ユーティリティ
```

## 処理フロー

1. CLIオプション解析(`argparse`)
2. 設定ファイル読込(`config.json`)
3. Ollamaクライアント初期化
4. 各アカウントについて以下を実行:
   a. 処理済みキャッシュを読込み、取得日数を超えた古いエントリをパージ
   b. IMAPサーバーに接続
   c. 設定されたフォルダ(デフォルト: INBOX)のメールを取得日数分取得(既読・未読問わず全件)
   d. 各メールについて:
      - メッセージハッシュで処理済みか判定(処理済みならスキップ、ログにも出力しない)
      - 全メールに対して5xxエラー抽出を試行(バウンス判定による事前フィルタなし)
      - DSN(message/delivery-status)の構造化解析で5xxエラーを抽出
      - 5xxが見つからなければスキップ
      - Ollamaにエラー情報を送信し、対応すべき担当者を分類
      - 分類結果に基づき、対象(target)または対象外(excluded)に振り分け
      - メッセージを処理済みとしてキャッシュに記録
   e. IMAP切断
   f. キャッシュを保存
   g. JSONレポート出力

## 5xxエラー検出ロジック

全てのメールに対して5xxエラーの有無を検査する。バウンスメールの形式(送信元、件名等)による事前フィルタは行わず、メール本文に5xxパターンが含まれているかどうかで判定する。

### 検出対象のメール形式

| 形式 | 処理方法 |
| --- | --- |
| text/plain のみ | そのままテキストとして解析 |
| text/html のみ | HTMLタグを除去してテキスト化し解析 |
| text/plain + text/html (multipart) | 両方のテキストを結合して解析 |

### DSN(Delivery Status Notification)解析(優先)

`message/delivery-status`パートを解析し、以下のフィールドを抽出:
- `Final-Recipient` / `Original-Recipient`: 配信失敗した宛先
- `Status`: 5.x.x形式のステータスコード
- `Diagnostic-Code`: SMTPエラーメッセージ

DSNパートが存在しないメールはバウンスとして検出されない(本文テキストの正規表現フォールバックは誤検出が多いため廃止)。

## AI分類

### プロンプト形式

Ollamaへの依頼はプレーンテキスト形式で行う(小規模モデルでのJSON出力の信頼性が低いため)。

送信情報: エラーコード、エラーメッセージ、宛先アドレス、バウンス通知本文(エラー内容のみ、先頭1000文字、text/plain優先→text/htmlフォールバック。元メッセージ本文は含まない)

応答形式(2行):

```text
CATEGORY: <カテゴリ名>
REASON: <日本語での理由>
```

正規表現でCATEGORY行とREASON行を抽出し、カテゴリが不正な場合は`unknown`(target扱い)にフォールバック。

### 分類カテゴリ

カテゴリ名は「対応者」と「問題の種類」を1次元に統合した命名とする。各カテゴリの`excluded`フラグにより、送信側で対応不要なカテゴリはexcludedに振り分けられる。

| カテゴリ | 対象 | 出力ファイル |
| --- | --- | --- |
| `ip_block` | 送信サーバーIP/ホストのブロックリスト登録(Spamhaus, RBL, DNSBL等) | target |
| `domain_block` | 送信ドメインのブロック・ポリシー拒否 | target |
| `sender_throttle` | 送信制限超過、スパムスロットリング、接続数超過 | target |
| `server_error` | 送信側サーバー停止、ディスク容量、TLS/証明書、内部エラー | target |
| `config_error` | DNS設定不備(SPF/DKIM/DMARC)、リレー拒否、ネットワーク/ルーティング | target |
| `user_unknown` | 宛先不明、存在しないアドレス、宛先ドメインのタイポ/DNS解決失敗 | excluded |
| `user_mailbox_full` | 宛先メールボックスの容量超過 | excluded |
| `user_rate_limit` | 受信者側のレート制限(受信レートが多すぎて配信不可） | excluded |

### ブロック種別の分類優先度

ブロック関連のエラーは、以下の優先順位でカテゴリを判定する:

1. **送信サーバーIP/ホストがブロックリストに登録** (例: "Client host blocked", Spamhaus, RBL, DNSBL) → `ip_block`
2. **送信ドメインのブロック** (例: ドメインがポリシーで拒否) → `domain_block`
3. **個別メールアドレスの拒否** (例: 宛先が不明・存在しない) → `user_unknown`

### 接続拒否・ポリシー拒否の分類

- 受信側サーバーが接続を拒否するケース（"refused to talk to me"、"connection refused"等）は、送信者がブロックされている可能性があるため `domain_block` に分類する。
- Microsoft EXOの "Recipient address rejected: Access denied"（550 5.4.1）は、受信者アドレスが存在しない・無効なケースであるため `user_unknown` に分類する。

### レート制限の分類

レート制限エラーは送信側と受信側で区別する:

- **受信者側**のレート制限(例: Gmail 5.2.1 "The user you are trying to contact is receiving mail at a rate that prevents delivery") → `user_rate_limit`（ユーザー起因・excluded）
- **送信側**のレート制限(送信量制限超過、スパムスロットリング、接続数超過) → `sender_throttle`（対応必要・target）

### DNS関連エラーの分類

- 宛先ドメインのDNS解決失敗(例: "Host or domain name not found", "Name service error")は、ユーザーがメールアドレスのドメイン部分を誤入力したケースとして `user_unknown` に分類する(例: `yhoo.co.jp` → `yahoo.co.jp` のタイポ)。
- 送信側のSPF/DKIM/DMARC失敗は `config_error` に分類する。

### DSN Diagnostic-Code不在時の動作

DSN解析で`Diagnostic-Code`が存在しない場合、`error_message`はプレースホルダー(`DSN status 5.x.x`)となる。詳細なエラー情報は`delivery_status`フィールドに保存されているため、レポート参照時に確認可能。

## 処理済みキャッシュ

- 保存場所: `{log_dir}/cache/{アカウント名}_processed.json`
- キー: メッセージのSHA-256ハッシュ(Message-IDベース、なければヘッダ+本文先頭200文字)
- 値: 追加日(ISO 8601形式)
- パージ: 起動時に取得日数(`days`)を超えたエントリを自動削除

## 出力

### JSONファイル

- 保存場所: `{log_dir}/` (configファイルからの相対パス)
- ファイル名: `{YYYYMMDD}_{アカウント名}_target.json`、`{YYYYMMDD}_{アカウント名}_excluded.json`
- エンコーディング: UTF-8
- フォーマット: 整形済みJSON (`indent=2`)
- 出力条件: 対象レコードが1件以上ある場合のみファイルを生成する(target/excludedそれぞれ独立判定。両方0件の場合はファイル自体を出力しない)
- 追記方式: 同日に複数回実行した場合、既存ファイルのレコードに新レコードを追記する(上書きしない)。キャッシュにより同じメールが重複追加されることはない。

### JSONフィールド

| フィールド | 内容 |
| --- | --- |
| `date` | バウンス通知の日時(メールのDateヘッダをローカル時間 `yyyy-MM-dd HH:mm:ss` に整形) |
| `folder` | メールフォルダ |
| `error_code` | 5xxエラーコード |
| `error_message` | エラーメッセージ |
| `ai_responsible_party` | AIによる対応すべき担当者 |
| `ai_reason` | AIの判断理由 |
| `from_addr` | 元の送信者アドレス |
| `to_addr` | 配信失敗した宛先アドレス |
| `subject` | 元のメール件名 |
| `body_plain` | バウンス通知のtext/plain(エラー内容のみ、先頭1000文字、空白・改行正規化済み) |
| `body_html` | バウンス通知のtext/html(エラー内容のみ、body抽出、style/script除去、先頭1000文字) |
| `body_plain_original` | 元メッセージのtext/plain(message/rfc822パートから抽出、先頭1000文字) |
| `body_html_original` | 元メッセージのtext/html(message/rfc822パートから抽出、先頭1000文字) |
| `delivery_status` | DSN(message/delivery-status)の構造化フィールド(dict)。per-messageフィールド(reporting_mta, arrival_date等)とper-recipientフィールド(status, diagnostic_code, remote_mta, action等)をマージ。DSN由来でない場合は空dict |

アカウント名はファイル名に含まれるためフィールドには含めない。

### HTMLレポート

- 保存場所: `{report_dir}/` (configファイルからの相対パス、デフォルト: `reports`)
- ファイル名: `report_{YYYYMMDD}.html`
- Bootstrap 5 (CDN) を使用したレスポンシブHTML
- 全アカウントを1ファイルに統合し、アカウント別 > target/excluded のセクション構造
- テーブルカラム: Date(日付/時間改行), Detail(category+reason+error code+message統合), From, To, Subject, Body(ボタン)
- Bodyボタンクリックでモーダルダイアログにbody_plain(なければbody_html)を表示
- `run` コマンド完了時に自動生成され、パスをログ出力

### 実行完了サマリー

全アカウントの処理完了後、全レコード(target/excluded)の件数をアカウント別・対応者別に集計してログ出力する。サマリー後、HTMLレポートの相対パスを出力する。

## CLI

サブコマンド方式を採用。サブコマンドは必須(`-v` によるバージョン表示を除く)。

### グローバルオプション

| オプション | 説明 | デフォルト |
| --- | --- | --- |
| `-c`, `--config` | 設定ファイルパス | `config.json`(カレントディレクトリ) |
| `-V`, `--verbose` | デバッグログ出力 | off |
| `-v`, `--version` | バージョン表示(pyproject.tomlから取得) | - |

### サブコマンド

#### run

バウンスメール取得・分類・レポート生成を実行する。

| オプション | 説明 | デフォルト |
| --- | --- | --- |
| `--days` | 取得日数(configの`default_days`を上書き) | configの値、未設定時30日 |

**日数の優先順位**: `--days`引数 > config `default_days` > 30日(ハードコードデフォルト)

#### cleanup [DATE]

指定された日付のレポートファイルとキャッシュエントリを削除する。日付省略時は今日を対象とする。

**対応日付フォーマット**: `yyyy-MM-dd`, `yyyy/MM/dd`, `yyyyMMdd`

**削除対象**:

- レポートJSON: `{log_dir}/{YYYYMMDD}_*_target.json`, `{YYYYMMDD}_*_excluded.json`
- キャッシュエントリ: 各アカウントのキャッシュから該当日付で記録されたエントリを削除

#### report [DATE]

指定された日付のレポートJSONを読み込み、カテゴリでフィルタリングしてアカウント別に表示する。日付省略時は今日を対象とする。

| オプション | 説明 | デフォルト |
| --- | --- | --- |
| `--category CATS` | 表示するカテゴリをカンマ区切りで指定 | target系カテゴリ |
| `--accounts ACCTS` | 表示するアカウントをカンマ区切りで指定 | 全アカウント |
| `--detail` | 各レコードのボディ内容(body_plain優先、なければbody_html)を表示 | off |

**対応日付フォーマット**: `yyyy-MM-dd`, `yyyy/MM/dd`, `yyyyMMdd`

**出力形式** (アカウント別・レポートファイル単位):

```text
--- {アカウント名} ({target|excluded}) [{件数} records] ---

[{error_code}] {error_message}
Category: {ai_responsible_party}
Reason: {ai_reason}
From: {from_addr}
To: {to_addr}

[{error_code}] {error_message}
...
```

`--detail` 指定時は各レコードに `<body>...</body>` ブロックで本文(body_plain優先、なければbody_html)が追加される。

### カテゴリ定義の一元管理

全カテゴリは `utils/categories.py` の `CATEGORIES` 辞書で一元管理される。各カテゴリには `description`(日本語説明)、`prompt`(Ollamaプロンプト用英語説明)、`excluded`(対応不要フラグ)の3フィールドがある。カテゴリの追加・変更時はこのファイルのみを修正すればよい。プロンプト生成・バリデーション・除外判定・レポート表示は全てこの辞書から導出される。
