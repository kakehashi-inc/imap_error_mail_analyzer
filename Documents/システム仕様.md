# システム仕様

## 概要

IMAP Error Mail Analyzerは、複数のIMAPメールアカウントからバウンスメール(5xxエラー)を検出し、Ollama LLMを使用して対応すべき担当者を自動分類し、CSVレポートとして出力するCLIツールである。

## アーキテクチャ

```
main.py                        CLI解析・オーケストレーション
  |
  +-- modules/config.py        設定読込・バリデーション
  +-- modules/imap_client.py   IMAP接続・メール取得
  +-- modules/bounce_parser.py 5xxエラー抽出
  +-- modules/ollama_client.py Ollama API分類
  +-- modules/report.py        CSV出力
  +-- modules/cache.py         処理済みハッシュキャッシュ
  |
  +-- utils/email_utils.py     メール解析汎用ユーティリティ
  +-- utils/logger.py          ログ設定ユーティリティ
```

## 処理フロー

1. CLIオプション解析(`argparse`)
2. 設定ファイル読込(`config.json`)
3. Ollamaクライアント初期化
4. 各アカウントについて以下を実行:
   a. 処理済みキャッシュを読込み、取得日数を超えた古いエントリをパージ
   b. IMAPサーバーに接続
   c. 設定されたフォルダ(デフォルト: INBOX)のメールを取得日数分取得(既読・未読問わず全件)
   d. 各メールについて:
      - メッセージハッシュで処理済みか判定(処理済みならスキップ、ログにも出力しない)
      - 全メールに対して5xxエラー抽出を試行(バウンス判定による事前フィルタなし)
      - DSN解析 -> 本文テキスト解析(text/plain + text/html)の優先順で5xxを検索
      - 5xxが見つからなければスキップ
      - Ollamaにエラー情報を送信し、対応すべき担当者を分類
      - 分類結果に基づき、対象(target)または対象外(excluded)に振り分け
      - メッセージを処理済みとしてキャッシュに記録
   e. IMAP切断
   f. キャッシュを保存
   g. CSVレポート出力

## 5xxエラー検出ロジック

全てのメールに対して5xxエラーの有無を検査する。バウンスメールの形式(送信元、件名等)による事前フィルタは行わず、メール本文に5xxパターンが含まれているかどうかで判定する。

### 検出対象のメール形式

| 形式 | 処理方法 |
| --- | --- |
| text/plain のみ | そのままテキストとして解析 |
| text/html のみ | HTMLタグを除去してテキスト化し解析 |
| text/plain + text/html (multipart) | 両方のテキストを結合して解析 |

### DSN(Delivery Status Notification)解析(優先)

`message/delivery-status`パートを解析し、以下のフィールドを抽出:
- `Final-Recipient` / `Original-Recipient`: 配信失敗した宛先
- `Status`: 5.x.x形式のステータスコード
- `Diagnostic-Code`: SMTPエラーメッセージ

### テキスト本文解析(フォールバック)

DSNが存在しない場合、メール本文(text/plain + text/html)から正規表現で5xxエラーパターンを検出:
- `5XX 5.x.x <message>` (SMTPコード + 拡張ステータスコード)
- `5XX <message>` (SMTPコードのみ)
- `5.x.x <message>` (拡張ステータスコードのみ)

5xxエラーコードは言語非依存の数値パターンであるため、メール本文の言語(英語、日本語、その他)を問わず検出可能。

## AI分類

### プロンプト形式

Ollamaへの依頼はプレーンテキスト形式で行う(小規模モデルでのJSON出力の信頼性が低いため)。

送信情報: エラーコード、エラーメッセージ、宛先アドレス、メール本文(先頭1000文字、text/plain優先→text/htmlフォールバック)

応答形式(2行):

```text
CATEGORY: <カテゴリ名>
REASON: <日本語での理由>
```

正規表現でCATEGORY行とREASON行を抽出し、カテゴリが不正な場合は`unknown`(target扱い)にフォールバック。

### 分類カテゴリ

| カテゴリ | 対象 | CSVファイル |
| --- | --- | --- |
| `server_admin` | 送信サーバーIP/ホストのブロックリスト登録(Spamhaus, RBL, DNSBL等)、サーバー停止、ディスク容量、TLS/証明書 | target |
| `service_admin` | 送信ドメインのブロック・ポリシー拒否、送信制限、アカウント無効化、スパムポリシー | target |
| `other_admin` | DNS設定不備、リレー、ネットワーク等の管理上の問題 | target |
| `user` | ユーザー起因の問題(アドレス入力ミス、存在しないメールボックス、メールボックス容量超過) | excluded |

### ブロック種別の分類優先度

ブロック関連のエラーは、以下の優先順位でカテゴリを判定する:

1. **送信サーバーIP/ホストのブロック** (例: "Client host blocked", Spamhaus, RBL, DNSBL) → `server_admin`
2. **送信ドメインのブロック** (例: ドメインがポリシーで拒否) → `service_admin`
3. **個別メールアドレスの拒否** (例: 宛先が不明・存在しない) → `user`

### DNS解決エラーの分類

宛先ドメインのDNS解決失敗(例: "Host or domain name not found", "Name service error")は、ユーザーがメールアドレスのドメイン部分を誤入力したケースとして `user` に分類する(例: `yhoo.co.jp` → `yahoo.co.jp` のタイポ)。

### DSN補完ロジック

DSN解析でDiagnostic-Codeが存在しない場合、error_messageはプレースホルダー(`DSN status 5.x.x`)となる。この場合、メール本文からPostfix形式の受信者エラー行(`<addr>: description`)を検索し、実際のエラー説明で補完する。

## 処理済みキャッシュ

- 保存場所: `{log_dir}/.cache/{アカウント名}_processed.json`
- キー: メッセージのSHA-256ハッシュ(Message-IDベース、なければヘッダ+本文先頭200文字)
- 値: 追加日(ISO 8601形式)
- パージ: 起動時に取得日数(`days`)を超えたエントリを自動削除

## 出力

### CSVファイル

- 保存場所: `{log_dir}/` (configファイルからの相対パス)
- ファイル名: `{YYYYMMDD}_{アカウント名}_target.csv`、`{YYYYMMDD}_{アカウント名}_excluded.csv`
- エンコーディング: UTF-8 with BOM
- 出力条件: 対象レコードが1件以上ある場合のみCSVファイルを生成する(target/excludedそれぞれ独立判定。両方0件の場合はファイル自体を出力しない)

### CSVカラム

| カラム | 内容 |
| --- | --- |
| `date` | バウンス通知の日時(メールのDateヘッダ) |
| `folder` | メールフォルダ |
| `error_code` | 5xxエラーコード |
| `error_cause` | エラーメッセージ |
| `ai_responsible_party` | AIによる対応すべき担当者 |
| `ai_reason` | AIの判断理由 |
| `from_addr` | 元の送信者アドレス |
| `to_addr` | 配信失敗した宛先アドレス |
| `subject` | 元のメール件名 |
| `body_plain` | text/plain本文(先頭1000文字、空白・改行正規化済み) |
| `body_html` | text/html本文(body抽出、style/script除去、HTMLタグ保持、先頭1000文字、空白・改行正規化済み) |

アカウント名はファイル名に含まれるためカラムには含めない。

## CLIオプション

| オプション | 説明 | デフォルト |
| --- | --- | --- |
| `-c`, `--config` | 設定ファイルパス | `config.json`(カレントディレクトリ) |
| `--days` | 取得日数(configの`default_days`を上書き) | configの値、未設定時30日 |
| `-v`, `--verbose` | デバッグログ出力 | off |
| `--version` | バージョン表示 | - |

### 日数の優先順位

`--days`引数 > config `default_days` > 30日(ハードコードデフォルト)
